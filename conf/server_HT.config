/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Nextflow config file for running the pipeline on  uman Technopole cluster
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Use as follows:
        nextflow run EmanuelSoda/spatialtranscriptomics -profile server_ht --outdir <OUTDIR>

----------------------------------------------------------------------------------------
*/

singularity.enabled = true
singularity.autoMounts = true
singularity.cacheDir = '/group/glastonbury/singularity-images/'
singularity.runOptions = ' --bind /group,/scratch,/home '
process.executor = 'slurm'
process.clusterOptions = ' --partition=cpuq '
process.maxRetries = 5


env {
    PATH='$PATH:/share/apps/spack/latest/linux-centos8-skylake_avx512/gcc-8.4.1/hdf5-1.12.2-wuenfteir2o62xl2f3jeavz6hrav5pdu/bin:/share/apps/spack/latest/linux-centos8-skylake_avx512/gcc-8.4.1/intel-oneapi-mpi-2021.4.0-j5of5pxz4vsmyxzxvqpzeuemtjbgyqdw/mpi/2021.4.0//libfabric/bin:/share/apps/spack/latest/linux-centos8-skylake_avx512/gcc-8.4.1/intel-oneapi-mpi-2021.4.0-j5of5pxz4vsmyxzxvqpzeuemtjbgyqdw/mpi/2021.4.0//bin:/cm/local/apps/cluster-tools/bin:/share/apps/spack/latest/linux-centos8-skylake_avx512/gcc-8.4.1/nextflow-22.10.1-hro7jrvuzlhxspofkx3jrnyxpyvbkuwj/bin:/share/apps/spack/latest/linux-centos8-skylake_avx512/gcc-8.4.1/openjdk-16.0.2-2yezvjv26vqypwq7s2tvpviklcbtkoq7/bin:/share/apps/spack/latest/linux-centos8-skylake_avx512/gcc-8.4.1/singularityce-3.10.3-ikfc62kkjjfwv672isynqlaz7ncrydwf/bin:/share/apps/spack/latest/linux-centos8-skylake_avx512/gcc-8.4.1/shadow-4.8.1-s2ajgkv6gqpjk2bv7wp5dyuud7f42cq3/bin:/share/apps/spack/latest/linux-centos8-skylake_avx512/gcc-8.4.1/go-1.18-4dkgzpxkrh3x5omgjhmnjbwgp6t3r7mf/bin:/share/apps/spack/latest/linux-centos8-skylake_avx512/gcc-8.4.1/conmon-2.0.30-kvmu6ts3crzjimn7tnz3fwp25cq2ln36/bin:/share/apps/spack/latest/linux-centos8-skylake_avx512/gcc-8.4.1/glib-2.70.5-xlqveyhkaqyaj6ksg26iinbi2jh2z3c5/bin:/share/apps/spack/latest/linux-centos8-skylake_avx512/gcc-8.4.1/python-3.9.10-wcqfksblynvpo5flnvuaedsrb4i2qmoq/bin:/share/apps/spack/latest/linux-centos8-skylake_avx512/gcc-8.4.1/util-linux-uuid-2.37.4-7g2rcwdrtvjvlxicpjlf4ulteqjuoxlk/bin:/share/apps/spack/latest/linux-centos8-skylake_avx512/gcc-8.4.1/pcre-8.45-52e3fh46hoejp25pyjjwvaimurbgmajl/bin:/share/apps/spack/latest/linux-centos8-skylake_avx512/gcc-8.4.1/gettext-0.20.2-gzsjp4vkpaux5zmsiyro5hytjv6kqxoh/bin:/share/apps/spack/latest/linux-centos8-skylake_avx512/gcc-8.4.1/ncurses-6.2-i6m24feshp3gmfb5jsu6nm66brslza3a/bin:/share/apps/spack/latest/linux-centos8-skylake_avx512/gcc-8.4.1/libiconv-1.16-t5owkk5wngfn7iclimlbacuw5uflrzra/bin:/group/glastonbury/conda_envs/nextflow23/bin:/home/emanuel.soda/miniconda3/condabin:/home/emanuel.soda/.vscode-server/bin/abd2f3db4bdb28f9e95536dfa84d8479f1eb312d/bin/remote-cli:/cm/shared/apps/slurm/current/sbin:/cm/shared/apps/slurm/current/bin:/cm/local/apps/environment-modules/4.5.3/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin:/usr/sbin:/cm/local/apps/environment-modules/4.5.3/bin:/opt/dell/srvadmin/bin:.'
}

params {
  // Limit resources so that this can run on GitHub Actions
  config_profile_name        = 'Config for server Human Technopole'
  config_profile_description = 'Config for server Human Technopole'
  max_cpus = 50
  max_memory = 200.GB
  max_time = 800.h
}

process {
    withName: 'NFCORE_SPATIALTRANSCRIPTOMICS:ST:FASTQC' {
        cpus = { check_max( 2 * task.attempt, 'cpus') }
        memory = { check_max( 2.GB * task.attempt, 'memory') }
    } 
    withName: 'NFCORE_SPATIALTRANSCRIPTOMICS:ST:SPACERANGER:SPACERANGER_UNTAR_REFERENCE' {
        cpus = { check_max( 10 * task.attempt, 'cpus') }
        memory = { check_max( 2.GB * task.attempt, 'memory') }
    }
    withName: 'NFCORE_SPATIALTRANSCRIPTOMICS:ST:SPACERANGER:SPACERANGER_COUNT' {
        cpus = { check_max( 32 * task.attempt, 'cpus') }
        memory = { check_max( 128.GB * task.attempt, 'memory') }
    }
    withName: 'NFCORE_SPATIALTRANSCRIPTOMICS:ST:ST_READ_DATA' {
        cpus = { check_max( 8 * task.attempt, 'cpus') }
        memory = { check_max( 32.GB * task.attempt, 'memory') }
    }
     withName: 'NFCORE_SPATIALTRANSCRIPTOMICS:ST:CUSTOM_DUMPSOFTWAREVERSIONS' {
        cpus = { check_max( 2 * task.attempt, 'cpus') }
        memory = { check_max( 2.GB * task.attempt, 'memory') }
    }
    withName: 'NFCORE_SPATIALTRANSCRIPTOMICS:ST:ST_POSTPROCESS:ST_CLUSTERING' {
        cpus = { check_max( 8 * task.attempt, 'cpus') }
        memory = { check_max( 20.GB * task.attempt, 'memory') }
    }
    withName: 'NFCORE_SPATIALTRANSCRIPTOMICS:ST:ST_PREPROCESS:ST_QC_AND_NORMALISATION' {
        cpus = { check_max( 8 * task.attempt, 'cpus') }
        memory = { check_max( 20.GB * task.attempt, 'memory') }
    }
    withName: 'NFCORE_SPATIALTRANSCRIPTOMICS:ST:ST_POSTPROCESS:ST_SPATIAL_DE' {
        cpus = { check_max( 10 * task.attempt, 'cpus') }
        memory = { check_max( 40.GB * task.attempt, 'memory') }
    }
}



